/*******************************************
	ILE_KANA.C	updated at 19th May 1989
	2-byte kana to internal code conversion
 *******************************************/

#define		EXT		extern

#include	"onsei.h"
#include	"ile_func.h"
#include	"ile_nydh.h"
#include	"ile_shdh.h"

/* JIS codes are in lower 8 bits.*/
/* Long-vowel symbols are processed separately.*/

static const BYTE kana_tbl[]={
	0x22,0x00,	0x00,	/* ア */
	0x24,0x00,	0x01,	/* イ */
	0x26,0x00,	0x02,	/* ウ */
	0x28,0x00,	0x03,	/* エ */
	0x2A,0x00,	0x04,	/* オ */

	0x2B,0x00,	0x08,	/* カ */
	0x2D,0x00,	0x09,	/* キ */
	0x2F,0x00,	0x0A,	/* ク */
	0x31,0x00,	0x0B,	/* ケ */
	0x33,0x00,	0x0C,	/* コ */
	0x2D,0x63,	0x0D,	/* キャ */
	0x2D,0x65,	0x0E,	/* キュ */
	0x2D,0x67,	0x0F,	/* キョ */

	0x35,0x00,	0x10,	/* サ */
	0x39,0x23,	0x11,	/* スィ */
	0x39,0x00,	0x12,	/* ス */
	0x3B,0x00,	0x13,	/* セ */
	0x3D,0x00,	0x14,	/* ソ */

	0x37,0x63,	0x18,	/* シャ */
	0x37,0x00,	0x19,	/* シ */
	0x37,0x65,	0x1A,	/* シュ */
	0x37,0x27,	0x1B,	/* シェ */
	0x37,0x67,	0x1C,	/* ショ */

	0x3F,0x00,	0x20,	/* タ */
	0x46,0x23,	0x21,	/* ティ */
	0x48,0x25,	0x22,	/* トゥ */
	0x46,0x00,	0x23,	/* テ */
	0x48,0x00,	0x24,	/* ト */

	0x41,0x63,	0x28,	/* チャ */
	0x41,0x00,	0x29,	/* チ */
	0x41,0x65,	0x2A,	/* チュ */
	0x41,0x27,	0x2B,	/* チェ */
	0x41,0x67,	0x2C,	/* チョ */

	0x44,0x21,	0x30,	/* ツァ */
	0x44,0x23,	0x31,	/* ツィ */
	0x44,0x00,	0x32,	/* ツ */
	0x44,0x27,	0x33,	/* ツェ */
	0x44,0x29,	0x34,	/* ツォ */

	0x4A,0x00,	0x38,	/* ナ */
	0x4B,0x00,	0x39,	/* ニ */
	0x4C,0x00,	0x3A,	/* ヌ */
	0x4D,0x00,	0x3B,	/* ネ */
	0x4E,0x00,	0x3C,	/* ノ */
	0x4B,0x63,	0x3D,	/* ニャ */
	0x4B,0x65,	0x3E,	/* ニュ */
	0x4B,0x67,	0x3F,	/* ニョ */

	0x4F,0x00,	0x40,	/* ハ */
	0x52,0x00,	0x41,	/* ヒ */
	0x55,0x00,	0x42,	/* フ */
	0x58,0x00,	0x43,	/* ヘ */
	0x5B,0x00,	0x44,	/* ホ */
	0x52,0x63,	0x45,	/* ヒャ */
	0x52,0x65,	0x46,	/* ヒュ */
	0x52,0x67,	0x47,	/* ヒョ */

	0x55,0x21,	0x48,	/* ファ */
	0x55,0x23,	0x49,	/* フィ */
	0x55,0x27,	0x4B,	/* フェ */
	0x55,0x29,	0x4C,	/* フォ */
	0x55,0x63,	0x4D,	/* フャ */
	0x55,0x65,	0x4E,	/* フュ */
	0x55,0x67,	0x4F,	/* フョ */

	0x5E,0x00,	0x50,	/* マ */
	0x5F,0x00,	0x51,	/* ミ */
	0x60,0x00,	0x52,	/* ム */
	0x61,0x00,	0x53,	/* メ */
	0x62,0x00,	0x54,	/* モ */
	0x5F,0x63,	0x55,	/* ミャ */
	0x5F,0x65,	0x56,	/* ミュ */
	0x5F,0x67,	0x57,	/* ミョ */

	0x64,0x00,	0x58,	/* ヤ */
	0x66,0x00,	0x5A,	/* ユ */
	0x68,0x00,	0x5C,	/* ヨ */

	0x69,0x00,	0x60,	/* ラ */
	0x6A,0x00,	0x61,	/* リ */
	0x6B,0x00,	0x62,	/* ル */
	0x6C,0x00,	0x63,	/* レ */
	0x6D,0x00,	0x64,	/* ロ */
	0x6A,0x63,	0x65,	/* リャ */
	0x6A,0x65,	0x66,	/* リュ */
	0x6A,0x67,	0x67,	/* リョ */

	0x6F,0x00,	0x68,	/* ワ */
	0x26,0x23,	0x69,	/* ウィ */
	0x26,0x27,	0x6B,	/* ウェ */
	0x26,0x29,	0x6C,	/* ウォ */

	0x2C,0x00,	0x70,	/* ガ */
	0x2E,0x00,	0x71,	/* ギ */
	0x30,0x00,	0x72,	/* グ */
	0x32,0x00,	0x73,	/* ゲ */
	0x34,0x00,	0x74,	/* ゴ */
	0x2E,0x63,	0x75,	/* ギャ */
	0x2E,0x65,	0x76,	/* ギュ */
	0x2E,0x67,	0x77,	/* ギョ */

	0x36,0x00,	0x80,	/* ザ */
	0x3A,0x23,	0x81,	/* ズィ */
	0x3A,0x00,	0x82,	/* ズ */
	0x45,0x00,	0x82,	/* ヅ */
	0x3C,0x00,	0x83,	/* ゼ */
	0x3E,0x00,	0x84,	/* ゾ */

	0x38,0x63,	0x88,	/* ジャ */
	0x38,0x00,	0x89,	/* ジ */
	0x38,0x65,	0x8A,	/* ジュ */
	0x38,0x27,	0x8B,	/* ジェ */
	0x38,0x67,	0x8C,	/* ジョ */

	0x42,0x63,	0x88,	/* ヂャ */
	0x42,0x00,	0x89,	/* ヂ */
	0x42,0x65,	0x8A,	/* ヂュ */
	0x42,0x27,	0x8B,	/* ヂェ */
	0x42,0x67,	0x8C,	/* ヂョ */

	0x40,0x00,	0x90,	/* ダ */
	0x47,0x23,	0x91,	/* ディ */
	0x49,0x25,	0x92,	/* ドゥ */
	0x47,0x00,	0x93,	/* デ */
	0x49,0x00,	0x94,	/* ド */
	0x47,0x63,	0x95,	/* デャ */
	0x47,0x65,	0x96,	/* デュ */
	0x47,0x67,	0x97,	/* デョ */

	0x50,0x00,	0x98,	/* バ */
	0x53,0x00,	0x99,	/* ビ */
	0x56,0x00,	0x9A,	/* ブ */
	0x59,0x00,	0x9B,	/* ベ */
	0x5C,0x00,	0x9C,	/* ボ */
	0x53,0x63,	0x9D,	/* ビャ */
	0x53,0x65,	0x9E,	/* ビュ */
	0x53,0x67,	0x9F,	/* ビョ */

	0x51,0x00,	0xA0,	/* パ */
	0x54,0x00,	0xA1,	/* ピ */
	0x57,0x00,	0xA2,	/* プ */
	0x5A,0x00,	0xA3,	/* ペ */
	0x5D,0x00,	0xA4,	/* ポ */
	0x54,0x63,	0xA5,	/* ピャ */
	0x54,0x65,	0xA6,	/* ピュ */
	0x54,0x67,	0xA7,	/* ピョ */

	0x74,0x21,	0xA8,	/* ヴァ */
	0x74,0x23,	0xA9,	/* ヴィ */
	0x74,0x00,	0xAA,	/* ヴ */
	0x74,0x27,	0xAB,	/* ヴェ */
	0x74,0x29,	0xAC,	/* ヴォ */
	0x74,0x63,	0xAD,	/* ヴャ */
	0x74,0x65,	0xAE,	/* ヴュ */
	0x74,0x67,	0xAF,	/* ヴョ */

	0x2F,0x21,	0xB0,	/* クァ */
	0x2F,0x23,	0xB1,	/* クィ */
	0x2F,0x27,	0xB3,	/* クェ */
	0x2F,0x29,	0xB4,	/* クォ */

	0x30,0x21,	0xB8,	/* グァ */
	0x30,0x23,	0xB9,	/* グィ */
	0x30,0x27,	0xBB,	/* グェ */
	0x30,0x29,	0xBC,	/* グォ */

	0x43,0x00,	0xCF,	/* ッ */
	0x72,0x00,	0x04,	/* ヲ */
	0x73,0x00,	0xD7,	/* ン */

	0x21,0x00,	0x00,	/* ァ */
	0x23,0x00,	0x01,	/* ィ */
	0x25,0x00,	0x02,	/* ゥ */
	0x27,0x00,	0x03,	/* ェ */
	0x29,0x00,	0x04,	/* ォ */
	0x63,0x00,	0x58,	/* ャ */
	0x65,0x00,	0x5A,	/* ュ */
	0x67,0x00,	0x5C,	/* ョ */
	0x6E,0x00,	0x68,	/* ヮ */
	0x70,0x00,	0x01,	/* ヰ */
	0x71,0x00,	0x03,	/* ヱ */
	0x75,0x00,	0x08,	/* ヵ */
	0x76,0x00,	0x0B,	/* ヶ */
	0					/* STOPPER */
};


/*========== kana_mora() ===========================
	Function:  Convert the 2-byte kana character string into the internal phonetic code.
	Value:	0: Conversion failed.
			1: Conversion succeeded.
  ==================================================*/
BOOL kana_mora() 
{
	integer_16 len,n;
	register BYTE *si,*bp;
	BYTE ch,a[2];
	
	si=ceptr*2+inert;
	len=celen;
	
	/* Offset of the mora data storage area */
	bp=kkana_buf;
	/* Resetting the mora length */
	kkana_len=0;
	
	for(;len>0;)
	{
		if(*si==0x21 && *(si+1)==0x3C)
		{
			if(kkana_len)
			{
				*bp++=0xC0;
			}
			else
			{
				*bp++=0xFF;	/* The long vowel at the top cannot be read.*/
			}
			si+=2; 
			--len; 
			++kkana_len;
		}
		else
		{
			a[0]=(*(si+1));
			if(len>1)
			{ 
				a[1]=(*(si+3)); 
				n=2; 
			}
			else
			{ 
				a[1]=0x00; 
				n=1; 
			}
			for(;n;)
			{
				if(kana_conv(a[0],a[1], &ch))
				{ 
					goto kana_mora100; 
				}
				a[--n]=0x00;
			}
			return 0;
kana_mora100:	
			si += n*2;		// Advance to the next wide character
			len -= n;		// adjust the input length
			*bp++ = ch;		// put the internal character into kana_buf
			++kkana_len;	// adjust the output length
		}
	}
	/*check_X(&kkana_buf,kkana_len);*/
	return 1;
}


/*========== kana_conv(a1,a2, ch) ======================
	Function:  Convert a character of 2-byte kana notation into the internal phonetic code.
	Value:	1 Conversion succeeded	
			O Conversion failed.
  ======================================================*/
BOOL kana_conv(BYTE a1, BYTE a2, BYTE *ch) 
{
	const BYTE* addr;
	addr=(&kana_tbl[0]);
	for(;*addr;addr+=3)
	{
		if(a1==(*addr) && a2==(*(addr+1)))
		{ 
			*ch=(*(addr+2)); 
			return 1; 
		}
	}
	return 0;
}



/***************************** END OF ILE_KANA.C *****************************/

